<!DOCTYPE HTML> 
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<style>

		html, body
		{
			margin: 0;
			height: 100%;
		}
		#buttonController
		{
		}

		#joystickController
		{
			padding: 0;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			position: absolute;
			text-align: center;
		}

		#controllerTable
		{
			position: absolute;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			height: 100%;	
			width: 100%;

		}
		.controllerButton
		{
			background-color: red;
			border: 1px solid black;
			text-align: center;
			width: 33.33333333333%;
			height: 33.33333333333%;
		}
		#bottomGoBackButton
		{
			position: fixed;
			bottom: 0;
			left: 0;
		}
		#homeScreen
		{
			margin: 8px;
			text-align: center;
		}
		#homeScreenTable
		{
			margin-left: auto;
			margin-right: auto;
		}
		#controllerJoystickCanvas
		{
			display: inline;
		}
	</style>
</head>
<div id = "homeScreen">
	Hello! Welcome to the minibot controller. Please select a method of controlling your minibot!

	<table id="homeScreenTable">
		<tr>
			<td><button id="goToJoystick">Joystick</button></td>
			<td><button id="goToButtons">Buttons</button></td>
		</tr>
	</table>
</div>

<div id = "buttonController">
	<table id="controllerTable">
		<tr>
			<td></td>
			<td id="forwardButton" class="controllerButton">Forward</td>
			<td></td>
		</tr>
		<tr>
			<td id="leftButton" class="controllerButton">Left</td>
			<td id="stopButton" class="controllerButton">Stop</td>
			<td id="rightButton" class="controllerButton">Right</td>
		</tr>
		<tr>
			<td id="goBackButton" class="controllerButton">Go Back to Main Page</td>
			<td id="reverseButton" class="controllerButton">Reverse</td>
			<td></td>
		</tr>
	</table>
</div>

<div id = "joystickController">
	<canvas id="controllerJoystickCanvas">
	</canvas>
	<button id ="bottomGoBackButton">Go Back</button>
</div>

</html>
<script type="text/javascript" src="js/jquery-1.12.1.min.js"></script>
<script type="text/javascript">
$("#buttonController").toggle();
$("#joystickController").toggle();
var canvas = document.getElementById("controllerJoystickCanvas");
var context = canvas.getContext("2d");

var count = 0;

context.fillStyle = "#FF0000";
context.fillRect(0,0,1400,400);
functReset(-1,-1);

window.onresize = function(event)
{
	functReset(-1,-1);
};

function functReset(x,y)
{
	var smallestSize = Math.min(window.innerWidth, window.innerHeight);
	context.canvas.width = smallestSize/2;
	context.canvas.height = smallestSize/2;
	drawBackground();
	drawCenter(x,y);
}

//$("#homeScreen").toggle(); //Delete before release

function drawBackground()
{
	var smallest = Math.min(canvas.width, canvas.height);
	context.beginPath();
	context.arc(smallest/2, smallest/2, smallest/3, 0, 2*Math.PI);
	context.stroke();
}



function drawCenter(x,y)
{
	var smallest = Math.min(canvas.width, canvas.height);
	if (x == -1 && y == -1)
	{
		x = smallest/2;
		y = smallest/2;
	}
	context.beginPath();
	context.arc(x, y, smallest/8, 0, 2*Math.PI);
	context.stroke();
}

var clicked = false;
var mouse = true;
$("#controllerJoystickCanvas").mousedown(function(){
	if (!mouse) return;
	functReset(-1,-1);
	moveRobot(0,0);
	clicked = true;
});

$(window).mouseup(function(){
	if (!mouse) return;
	console.log(!$("joystickController").is(":visible"));
	if ($("joystickController").is(":visible")) return;
	{
		functReset(-1,-1);
		moveRobot(0,0);
		clicked = false;
	}
});



$("#controllerJoystickCanvas").mousemove(function(data){
	if (!mouse) return;
	if (!clicked) return;

	var location = mousePosition(canvas,data);
	moveController(location);
});

function moveController(location)
{
	var smallest = Math.min(canvas.width, canvas.height);
	functReset(location.x, location.y);

	var forwardNoSensor = -(location.y-smallest/2)/(smallest/3);
	var rightNoSensor = (location.x-smallest/2)/(smallest/3);
	var leftMotor = 100*rightNoSensor+100*forwardNoSensor
	var rightMotor = -100*rightNoSensor+100*forwardNoSensor
	if (leftMotor>100) leftMotor = 100;
	if (leftMotor<-100) leftMotor = -100;
	if (rightMotor>100) rightMotor = 100;
	if (rightMotor<-100) rightMotor = -100;
	if (count >= 10)
	{
		moveRobot(leftMotor,rightMotor);
		count = 0;
	}
	else
		count++;
	
}

function mousePosition(obj, location)
{
	var rect = obj.getBoundingClientRect();
	return {
		x: location.clientX - rect.left,
		y: location.clientY - rect.top
	}
}

$(document).ready(function(){
	$("#rightButton").click(function(){
		moveRobot(-100, 100);
	});

	$("#forwardButton").click(function(){
		moveRobot(100, 100);
	});

	$("#stopButton").click(function(){
		moveRobot(0, 0);
	});

	$("#leftButton").click(function(){
		moveRobot(100, -100);
	});

	$("#reverseButton").click(function(){
		moveRobot(-100, -100);
	});

	$("#goBackButton").click(function(){
		$("#buttonController").toggle();
		$("#homeScreen").toggle();
	});
});

$(document).ready(function(){
	$("#bottomGoBackButton").click(function(){
		$("#joystickController").toggle();
		$("#homeScreen").toggle();
	});

});

$(document).ready(function(){
	$("#goToButtons").click(function(){
		$("#buttonController").toggle();
		$("#homeScreen").toggle();
	});

	$("#goToJoystick").click(function(){
		$("#joystickController").toggle();
		$("#homeScreen").toggle();
	});
});

function moveRobot(leftMotor, rightMotor)
{
	var object = {left: leftMotor, right: rightMotor};
	var output = JSON.stringify(object);
	$.post("/command", output, function(input){
		console.log(input);
	});
	console.log(output);
};

//$.get("/test","test");

</script>